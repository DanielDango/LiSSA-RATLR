%% LaTeX2e class for student theses
%% sections/evaluation.tex
%% 
%% Karlsruhe Institute of Technology
%% Institute of Information Security and Dependability
%% Software Design and Quality (SDQ)
%%
%% Dr.-Ing. Erik Burger
%% burger@kit.edu
%%
%% Version 1.6, 2024-06-07

\chapter{Evaluation}
\label{ch:Evaluation}

\Todo{Talk about evaluation in general}

\section{Naive Prompt Optimization}
\label{sec:Evaluation:FirstSection}

The initial thought people may have when thinking about prompt optimization is to ask the \LLM to optimize the prompt before usage. To utilize this very simple approach, just two prerequisites are required. Firstly, we need our prompt, which is to be optimized. \autoref{prompt:yes_no} was chosen here as the initial prompt. It is a \KISS binary classification prompt. As the \LiSSAf has already employed this prompt for their simple classifier, I decided to start the optimization process with this prompt as well. Secondly, an optimization prompt is needed. Herefore \autoref{prompt:initial_optimization} has been arbitrarily selected. Unlike \autoref{prompt:yes_no}, this prompt has not been used yet to my knowledge. %Was it written utilizing IntelliJ's ai assistant autocompletion? I believe so...

\begin{prompt}{\KISS Original}{yes_no}\\
    Question: Here are two parts of software development artifacts.\\
    \{source\_type\}: \tripplequote \{source\_content\}\tripplequote\\
    \{target\_type\}: \tripplequote\{target\_content\}\tripplequote\\
    Are they related?\\
    Answer with \textquotesingle{}yes\textquotesingle{} or \textquotesingle{}no\textquotesingle{}.
\end{prompt}

\begin{prompt}{Simple Optimization Prompt}{initial_optimization}\\
    Optimize the following prompt to achieve better classification results for traceability link recovery. \\
    Traceability links are to be found in the domain of \{source\_type\} to \{target\_type\}. \\
    Do not modify the input and output formats specified by the original prompt.\\
    Enclose your optimized prompt with <prompt></prompt> brackets.\\
    The original prompt is provided below:\\
    \tripplequote\{original\_prompt\}\tripplequote
\end{prompt}

With these two prompts the naive prompt optimization can be evaluated. The results seemed to be quite consistent across different tested \LLMs. I will present the optimized prompts by OpenAI's GPT-4o model as an example of these.
\Todo{Add other models' outputs to the appendix?}

\subsection{Optimized Prompt Analysis}
The first application of the optimization prompt usually yielded an inclusion of the source and target types into the text of the prompt. This was possible as a set of training data was also provided for later, more sophisticated prompt optimization approaches. Further, the very simple classification question "Are they related?" was also expanded to be more specific for the \TLR problem.  The result can be seen in \autoref{prompt:yes_no_simple}.
The optimized prompt only depends on the input prompt and the domain of the source and target elements. This very prompt thus is used for all simple GPT-4o evaluations in \autoref{tab:naive_optimization} for the domain of \RtR. 

\begin{prompt}{\KISS Single Optimization Step}{yes_no_simple}\\
    Question: Below are two components from software development artifacts that need to be analyzed for traceability.\\

            Source Requirement \{source\_type\}: \tripplequote\{source\_content\}\tripplequote

            Target Requirement \{target\_type\}: \tripplequote\{target\_content\}\tripplequote
            
            Based on the content and context, determine if there is a traceability link between them.

            Answer with \textquotesingle{}yes\textquotesingle{} or \textquotesingle{}no\textquotesingle{}.
    
\end{prompt}

As seen in \autoref{tab:naive_optimization}, application of the optimization prompt seems to generally improve the $f_1-score$. 
By repeatedly applying the optimization prompt to the optimized prompt of the previous iteration, we can push this optimization further.
This yields \autoref{prompt:yes_no_iterative}
Once more, the behavior of different \LLMs is quite similar here.
We can see that mostly longer and more detailed instructions are included on how to find \TLs. 
However, unfortunately, this prompt does not necessarily perform better for our task. 
The performance of this prompt, as seen in \autoref{tab:naive_optimization}, seems to be generally worse than just the singular optimization application.

\begin{prompt}{\KISS Single Iterative Dumb Optimization}{yes_no_iterative}\\
    Question: You are given two components from software development artifacts that need to be analyzed for traceability link recovery in the domain of requirement to requirement.\\
    
    \{source\_type\}: \tripplequote\{source\_content\}\tripplequote

    \{target\_type\}: \tripplequote\{target\_content\}\tripplequote

    Carefully analyze both components to determine if a traceability link exists between them. Focus on identifying shared terminology, dependencies, logical connections, and alignment of objectives and constraints. Look for direct references, similar phrasing, or common goals that might indicate a connection. Evaluate the consistency of requirements, the presence of complementary or supplementary information, and any historical or contextual relationships that could suggest a link. Consider the intent and purpose behind each requirement to ensure a thorough analysis. Pay special attention to any implicit connections that may not be immediately obvious but are crucial for understanding the relationship. Use a systematic approach to ensure no potential link is overlooked. Prioritize clarity and precision in your analysis to enhance the accuracy of your classification.

    Answer with \textquotesingle{}yes\textquotesingle{} or \textquotesingle{}no\textquotesingle{}.
    
\end{prompt}

\subsection{Systematic Evaluation Results}

\begin{table}
    \centering
    \renewcommand{\arraystretch}{1.4}
    \input{tables/SimpleAndRepeatedOptimization}
    \renewcommand{\arraystretch}{1}
    \caption{Naive prompt optimization approach prompting the model to optimize the classification prompt}
    \label{tab:naive_optimization}
\end{table}

\newpage
\section{Simple Feedback Optimization}

The following parameters will be used to describe prompts for this section. They can be used as configuration parameters for the feedback optimization process.

\begin{align*}
    mi:=  & \text{maximum iterations}\\
          & \text{the prompt will be optimized $mi$ times} \\
    n  := & \text{feedback sample size}\\  
          & \text{$n$ examples of misclassified \TLs will be provided}
\end{align*}

\begin{prompt}{Feedback Prompt}{feedback_initial}\\
    The current prompt is not performing well in classifying the following trace links. To help you improve the prompt, I will provide examples of misclassified trace links. Please analyze these examples and adjust the prompt accordingly. The examples are as follows: \\
    \{identifier\}\\
    \{source\_type\}: \tripplequote\{source\_content\}\tripplequote\\
    \{target\_type\}: \tripplequote\{target\_content\}\tripplequote\\
    Classification result: \{classification\}
\end{prompt}

\subsection{Optimized Prompt Analysis}

\begin{prompt}{Optimized Prompt n = 3, mi = 1}\\
Question: Here are two parts of software development artifacts.

\{source\_type\}: \tripplequote\{source\_content\}\tripplequote

\{target\_type\}: \tripplequote\{target\_content\}\tripplequote

Consider the following when determining if they are related:\\
1. Look for shared terminology or concepts, such as specific functions, interfaces, or standards mentioned in both requirements.\\
2. Assess whether one requirement describes a feature or functionality that directly supports or complements the other.\\
3. Determine if there is a dependency or a logical connection between the two requirements, such as one requirement ensuring compatibility or compliance that the other relies on.

Are they related?

Answer with \textquotesingle{}yes\textquotesingle{} or \textquotesingle{}no\textquotesingle{}.
\end{prompt}

\begin{prompt}{Optimized Prompt n = 5, mi = 10}\\
Question: Here are two parts of software development artifacts.

\{source\_type\}: \tripplequote\{source\_content\}\tripplequote

\{target\_type\}: \tripplequote\{target\_content\}\tripplequote

Consider the following when determining if they are related:

1. Identify shared terminology or concepts, such as specific functions, interfaces, standards, or types of records mentioned in both requirements. Pay attention to synonyms or closely related terms that may indicate a connection.

2. Evaluate whether one requirement describes a functionality or feature that directly supports, complements, or is necessary for the implementation of the other. Consider if one requirement provides a foundation or prerequisite for the other.

3. Determine if there is a dependency, logical connection, or encapsulation relationship between the two requirements, such as one requirement ensuring compatibility, compliance, or abstraction that the other relies on. Consider if changes in one requirement would impact the other.

\[\dots\]

11. Look for explicit mentions of memory management, remote management, or other specific functionalities that might indicate a relationship, even if not directly related to WARC records.

12. Consider the broader context of the requirements, such as the overall architecture or design principles they support, to identify indirect relationships.

13. Pay attention to the specific phrasing and structure of the requirements, as similar language or structure can indicate a relationship.

14. Consider the intent and purpose behind each requirement, as aligning intents can suggest a relationship even if the specifics differ.

15. Evaluate if the requirements mention or imply the need for compatibility or interoperability, as this can indicate a relationship.

16. Consider if the requirements address scalability, performance, or optimization aspects that might be interrelated.

17. Look for any implicit or explicit dependencies that might not be immediately obvious but are crucial for the system's functionality.

18. Pay attention to the specific types of WARC records mentioned and whether they are addressed in both requirements, as this can indicate a direct relationship.

19. Consider if the requirements mention or imply the need for a single header file or universal interface, as this is a critical aspect in this domain.

20. Reflect on whether the requirements address encapsulation or abstraction, as these are key concepts that often indicate a relationship.

Are they related?

Answer with \textquotesingle{}yes\textquotesingle{} or \textquotesingle{}no\textquotesingle{}.
\end{prompt}
\subsection{Systematic Evaluation Results}

\begin{landscape}
\begin{table}
    \centering
    \renewcommand{\arraystretch}{1}
    \input{tables/FeedbackOptimizer}
    \renewcommand{\arraystretch}{1}
    \caption{Naive prompt optimization approach considering previous misclassified \TLs}
    \label{tab:placeholder}
\end{table}
\end{landscape}